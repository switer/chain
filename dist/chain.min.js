/**
* Chainjs v0.2.0
* http://github.com/switer/chainjs
*
* (c) 2015 guankaishe
* Released under the MIT License.
*/
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Chain=e():t.Chain=e()}(this,function(){return function(t){function e(s){if(n[s])return n[s].exports;var i=n[s]={exports:{},id:s,loaded:!1};return t[s].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function s(){var t=new i;return arguments.length&&o(t,arguments),t}function i(){this.props={},this.state={},this.props._context=this,this.props._data={},this.props._nodes=new p,this.props._finals=[]}function r(){var t={items:u.slice(arguments),state:{}},e=this.props._nodes.add(t);return t.id=e,t}function o(t,e){return r.apply(t,"array"==u.type(e[0])?e[0]:e)}function a(){}function h(t,e){u.each(e,function(e){t[e]=a})}function p(){var t=1;this._link=[],this._map={},this._allot=function(){return t++}}var u=n(1);s.thunk=function(t){return function(e){var n=u.slice(arguments);n.shift(),n.push(e.next),t.apply(null,n)}},i.prototype={then:function(){return this.state._destroy?void 0:(o(this,arguments),this)},some:function(){if(!this.state._destroy){var t=o(this,arguments);return t.items.length&&(t.type="some"),this}},each:function(){if(!this.state._destroy){var t=this,e=u.slice(arguments);return e="array"==u.type(e[0])?e[0]:e,u.each(e,function(e){r.call(t,e)}),this}},next:function(){if(!this.state._end&&!this.state._destroy){var t,e=u.slice(arguments);if(this.__id){if(t=this.props._nodes.get(this.__id),t.state._isDone)return;if(this.__branchGoto);else if(t.state._multiple&&"some"==t.type){if(!t.state._pending)return;if(~t.state._dones.indexOf(this.__index)&&t.state._dones.push(this.__index),t.state._dones.length>=1)return;t.state._pending=!0}else if(t.state._multiple){if(!t.state._pending)return;if(~t.state._dones.indexOf(this.__index)||t.state._dones.push(this.__index),t.state._dones.length!=t.items.length)return;t.state._pending=!0}t.state._isDone=!0}if(this.__branchGoto){if(t=this.props._nodes.getByProp("name",this.__branchGoto),!t)throw new Error("Branch is not exist !");if(this.__id&&!this.props._nodes.isNextTo(t.id,this.__id))throw new Error("Can not goto previous step !")}else{if(this.props._nodes.isLast(this.__id))return this.end.apply(this,arguments);for(t=this.__id?this.props._nodes.next(this.__id):this.props._nodes.first();t&&"branch"==t.type;)t=this.props._nodes.next(t.id);if(!t)return this.end.apply(this,arguments)}if(t.items.length){t.items.length>1&&(t.state._multiple=!0,t.state._pending=!0,t.state._dones=[]);var n=this;if(t.items)for(var s=n.constructor.prototype,i=0;i<t.items.length;i++){var r=t.items[i],o=e,a=u.create(function(){this.__id=t.id,this.__index=i,this.__callee=r,this.__arguments=o,this.state=n.state,this.props=n.props},s),h=new a;h.next=u.bind(s.next,h),o.unshift(h),r.apply(n.props._context,o)}return this}}},nextTo:function(t){if(!this.state._destroy){u.want(t,"string"),this.__branchGoto=t;var e=u.slice(arguments);e.shift(),this.next.apply(this,e)}},branch:function(t,e){if(!this.state._destroy){u.want(t,"string"),u.missing(e,"handler");var n=r.call(this,e);return n.type="branch",n.name=t,this}},retry:function(){this.state._end||this.state._destroy||this.__callee.apply(this.props._context,this.__arguments)},wait:function(t){if(!this.state._destroy){var e=this,n=u.slice(arguments);n.shift(),setTimeout(function(){e.next.apply(e,n)},t)}},data:function(t,e){if(!this.state._destroy){var n=u.slice(arguments),s=n.length;if(s>=2)return this.props._data[t]=e,this;if(1!==s||"object"!=u.type(t))return 1===s?this.props._data[t]:u.merge({},this.props._data);for(var i in t)this.props._data[i]=t[i]}},start:function(){return this.state._end||this.state._destroy?void 0:(this.next.apply(this,arguments),this)},end:function(){return this.state._end||this.state._destroy?void 0:(this.state._end=!0,u.batch.apply(u,[this.props._context,this.props._finals,this].concat(u.slice(arguments))),this)},"final":function(t){return this.state._destroy?void 0:(this.props._finals.push(t),this)},destroy:function(){return this.state._destroy=!0,this.props._context=null,this.props._data=null,this.props._nodes=null,this.props._finals=null,h(this,["then","some","next","nextTo","branch","retry","wait","data","start","end","final","destroy"]),this},context:function(t){return this.state._destroy?void 0:(this.props._context=t,this)}},i.prototype.constructor=i,p.prototype={add:function(t){var e=this._allot();return this._map[e]=t,this._link.push(e),e},isLast:function(t){return this._link.indexOf(t)===this._link.length-1},first:function(){return this._map[this._link[0]]},get:function(t){return this._map[t]},next:function(t){var e=this._link.indexOf(t)+1;return this._map[this._link[e]]},getByProp:function(t,e){var n,s=this;return u.some(this._link,function(i){var r=s.get(i);return r[t]===e?(n=r,!0):void 0}),n},isNextTo:function(t,e){return this._link.indexOf(t)>this._link.indexOf(e)}},t.exports=s},function(t,e){"use strict";t.exports={each:function(t,e,n){if(t)if(t.forEach)t.forEach(e);else if(t.length==+t.length)for(var s=0;s<t.length;s++)e.call(n,t[s],s);else for(var i in t)e.call(n,t[i],i)},some:function(t,e){if(t)if(t.some)t.forEach(e);else for(var n=0;n<t.length&&!e.call(null,t[n],n);n++);},batch:function(t,e){var n=this.slice(arguments);n.shift(),n.shift(),this.each(e,function(e){e&&e.apply(t,n)})},bind:function(t,e){return function(){t.apply(e,arguments)}},slice:function(t){for(var e=t.length,n=new Array(e);e;)e--,n[e]=t[e];return n},merge:function(t,e){return this.each(e,function(n,s){e.hasOwnProperty(s)&&(t[s]=n)}),t},type:function(t){return/\[object ([a-zA-Z]+)\]/.exec(Object.prototype.toString.call(t))[1].toLowerCase()},missing:function(t,e){if(!t)throw new Error("Missing param: "+e)},want:function(t,e){if(this.type(t)!=e)throw new Error("Want param "+t+" type is a/an "+e)},create:function(t,e){function n(){}return n.prototype=e,t.prototype=new n,t.prototype.constructor=n,t}}}])});